<!-- TODO  make Javascript call again after 5 mins (saves refresh page) -->
<!-- TODO  Improve javascript structure  -->

<!doctype html>
<html lang="en">
<head>
<title>Temp Graph</title>
<meta http-equiv="refresh" content="300">
<link rel="icon" href="data:," />
<script type="application/javascript">

const C_HEIGHT = 220;
const C_WIDTH = 630;
const X_AXIS = 25
const Y_AXIS = 200;
const G_WIDTH = 600;
const G_HEIGHT = 200;
const G_MAX_NO = 290; // 2 pix per 5 mins 24 hrs

function getTime(data)
{
    return data[0];
}

function getTemp(data)
{
    return data[1][0];
}

function getPressure(data)
{
    return data[1][1];
}

function getHumidity(data)
{
    return data[1][2];
}

function mapTemp(data)
{
    return [data[0], data[1][0]];
}

function mapPressure(data)
{
    return [data[0], data[1][1]];
}

function mapHumidity(data)
{
    return [data[0], data[1][2]];
}

// round up to the nearest increment
function round_to_inc(num, inc)
{
    x = Math.floor(num);
    while (x < num) x += inc;
    return x;
}

class Graph
{
    ctx;
    mapFn;
    getFn;
    mn; // [date, min]
    mx; // [date, max]
    envData;
    startDate;
    endDate;
 
    constructor(canvas, envData, mapFn, getFn)
    {
        this.envData = envData;
        this.mapFn = mapFn;
        this.getFn = getFn;
        this.ctx = document.getElementById(canvas).getContext("2d");
        this.ctx.font = "12px Arial";
// debugger;

        this.mn = this.min();
        this.mx = this.max();

        this.scale = this.getScale();
        console.log("min x: ", this.mn, " max:", this.mx, "scale:", this.scale);
        this.startDate = new Date(envData[0][0] * 1000);
        this.endDate = new Date(envData[envData.length - 1][0] * 1000);
    }

    min() {
        return this.envData.map(this.mapFn).reduce(function (a, b) {
           return a[1] < b[1]  ? a : b;
       });
    }

    max() {
        return this.envData.map(this.mapFn).reduce(function (a, b) {
           return a[1] > b[1] ? a : b;
       });
    }

    // 200 pixels
    getScale()
    {
        const diff = this.mx[1] - this.mn[1];
        if (diff <= 0.5)
            return 400;
        if (diff <= 1)
            return 200;
        if (diff <= 2)
            return 100;
        if (diff <= 4)
            return 50;
        if (diff <= 5)
            return 40;
        if (diff <= 10)
            return 20;
        if (diff <= 20)
            return 10;
        if (diff <= 25)
            return 8;
        if (diff <= 50)
            return 4;
        if (diff <= 100)
            return 2
       return 200 / diff;
    }

    axis()
    {
        // draw X Axis
        this.ctx.beginPath()
        this.ctx.strokeStyle = "blue";
        this.ctx.lineWidth = 1;
        this.ctx.moveTo(X_AXIS, 0);
        this.ctx.lineTo(X_AXIS, C_HEIGHT);

        // draw Y Axis
        this.ctx.moveTo(0, Y_AXIS);
        this.ctx.lineTo(C_WIDTH, Y_AXIS)
        this.ctx.stroke();

        // draw X scale
        const inc = G_HEIGHT / (this.scale * 10);
        var temp = round_to_inc(this.mn[1], inc);

        this.ctx.beginPath()
        this.ctx.textBaseline = "bottom";
        this.ctx.strokeStyle = "lightblue";
        this.ctx.lineWidth = 1;

        for (var y = 0; y < 10; y++)
        {
            var tempy = Y_AXIS - (temp - this.mn[1]) * this.scale;
            this.ctx.fillText(temp.toFixed(1), 0, tempy);
            this.ctx.moveTo(X_AXIS + 1, tempy);
            this.ctx.lineTo(C_WIDTH, tempy);
            temp += inc;
        }
        this.ctx.stroke();

        // draw Y scale
        let hr = this.startDate.getHours();
        const mi = this.startDate.getMinutes();
        const z = X_AXIS + ((60 - mi)/ 60) * 24;
        const end = X_AXIS + G_MAX_NO * 2;
        if (mi !=0) hr++;

        this.ctx.beginPath()
        for (var x = z; x < end; x+=24)
        {
            this.ctx.fillText(hr, x, Y_AXIS + 14);
            this.ctx.moveTo(x, 0);
            this.ctx.lineTo(x, Y_AXIS - 1);
            hr++;
            if (hr == 24) hr = 0;
        }
        this.ctx.stroke();
    }

    drawGraph()
    {
        let data = this.envData.shift();
        let temp = this.getFn(data);
        data = this.envData[this.envData.length - 1];

        let tempy = Y_AXIS - (temp - this.mn[1]) * this.scale;

        this.ctx.beginPath()
        this.ctx.strokeStyle = "black";
        this.ctx.lineWidth = 1;

        let x = X_AXIS;
        this.ctx.moveTo(x, tempy)

        for (let d of this.envData)
        {
            x = x + 2;
            temp = this.getFn(d); 
            tempy = Y_AXIS - (temp - this.mn[1]) * this.scale;
            this.ctx.lineTo(x, tempy);
        }

        this.ctx.stroke();
    }
}

var request = new XMLHttpRequest();

request.open('GET', 'http://192.168.43.149:65510');

request.onload = function () {
    var response = request.response;
    var envData = JSON.parse(response);

    if (envData.length < 2)
    {
        document.getElementById("today").innerHTML = "No data avaliable";
        return;
    }

    const pos = envData.length > G_MAX_NO ? -G_MAX_NO : 0;
    envData = envData.slice(pos);

    tg = new Graph("graph1", envData, mapTemp, getTemp);
    tg.axis();
    tg.drawGraph();

    const today = new Date();
    const mnd = new Date(tg.mn[0] * 1000);
    const mxd = new Date(tg.mx[0] * 1000);
    document.getElementById("today").innerHTML = "Today: " + today.toLocaleString();
    document.getElementById("tmin").innerHTML = `min: ${tg.mn[1].toFixed(1)}C at ${mnd.toLocaleString()}` +
                                           `<br\>max: ${tg.mx[1].toFixed(1)}C at ${mxd.toLocaleString()}`;
    document.getElementById("tdates").innerHTML = "Start: " + tg.startDate.toLocaleString() + 
                                               "<br\>End: " + tg.endDate.toLocaleString();

    pg = new Graph("graph2", envData, mapPressure, getPressure);
    pg.axis();
    pg.drawGraph();

    pg = new Graph("graph3", envData, mapHumidity, getHumidity);
    pg.axis();
    pg.drawGraph();
}

//debugger;
request.send();

</script>
</head>
<body>
<h4 id="today"></h4>
<p>Temperature Graph</p>
<canvas id="graph1" width="630" height="220" style="border: 0px solid black;"></canvas>
<p id="tdates"></p>
<p id="tmin"></p>
<hr/>
<p>Pressure Graph</p>
<canvas id="graph2" width="630" height="220" style="border: 0px solid black;"></canvas>
<p id="pdates"></p>
<p id="pmin"></p>
<hr/>
<p>Humidity Graph</p>
<canvas id="graph3" width="630" height="220" style="border: 0px solid black;"></canvas>
<p id="hdates"></p>
<p id="hmin"></p>
</body>
</html>
